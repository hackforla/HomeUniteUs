# OpenAPI generated server

## Overview

This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) from a remote server, you can easily generate a server stub. This
is an example of building a OpenAPI-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Requirements

Python 3.5.2+

## Usage

To run the server, please execute the following from the root directory:

```
pip3 install -r requirements.txt
alembic upgrade head
python3 -m openapi_server
```

If you're seeing error messages, this may be related to missing environment variables. In the `api/` directory create a `.env` file and copy and paste the variable definitions from `.env.example`. Message a team member to receive the necessary values.

and open your browser to here:

```
http://localhost:8080/api/ui/
```

Your OpenAPI definition lives here:

```
http://localhost:8080/api/openapi.json
```

To launch the integration tests, use tox:

```
sudo pip install tox
tox
```

## Alembic migrations

When changing the database, you can automatically generate an alembic migration. Simply change the model however you want in `database.py`, run `alembic revision --autogenerate -m <name_of_migration>` to generate a new migration, and then run `alembic upgrade head` to upgrade your database to the latest revision.
In the case of someone else adding a revision to the database, simply pull their changes to your repo and run `alembic upgrade head` to upgrade your local database to the latest revision.

## Making changes to the openapi specification

In order to make changes to the openapi specification you should edit the files within the `openapi_server/openapi` folder.
You should NOT make any manual changes to the file in the `_spec` folder, as this is an auto-generated file compiled from the smaller files in the `openapi` folder.

After making your changes, you can recompile the file in the `_spec` folder by running the following command:

```
swagger-cli bundle openapi_server/openapi/openapi.yaml \
    --outfile openapi_server/_spec/openapi.yaml \
    --type yaml
```

If you do not have `swagger-cli` installed, you can install it with the following command:

```
npm install -g swagger-cli
```

## Running with Docker

To run the server on a Docker container, please execute the following from the root directory:

```bash
# building the image
docker build -t openapi_server .

# starting up a container
docker run -p 8080:8080 openapi_server
```

## Running with Docker Compose

If it's your first time running/building the containers run the following command from the root directory:

```
docker compose up api --build
```

This command will build and start both the api and db containers. You can check they are running by with:

```
docker ps
```

You should see two containers running with the names `homeuniteus-api-1` and `homeuniteus-db-1`. For subsequent runs you can simply run:

```
docker compose up api
```

To stop the containers run:

```
docker compose down
```

If you would like to interact with the postgres database you can run. Make sure you have the postgres client installed on your machine and have the database container running. Then use the command:

```
docker exec -it homeuniteus-db-1 psql -U postgres -W huu
```

This will prompt you for a password. The password is `postgres`. You can see this information in the `docker-compose.yml` file. This starts a new psql session. You can then run any psql commands you would like. For example, to see all the tables in the database run:

```
\dt
```

or to select all the users from the `user` table run:

```
SELECT * FROM public.user;
```

to end the session just type `\q`.

If you want to clear the databse and start from scratch you can run:

```
docker compose down -v
```

This command will stop the containers and delete the volumes. Then you can run `docker compose up api --build` to build and start the containers again.
